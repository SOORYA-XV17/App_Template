<!-- Enhanced Loading Overlay -->
<div *ngIf="isLoading" class="loading-overlay fixed inset-0 flex items-center justify-center z-50">
  <div class="text-center">
    <div class="loading-spinner mx-auto"></div>
    <p class="mt-6 text-gray-700 font-medium">Loading dashboard...</p>
    <div class="mt-2 w-32 h-1 bg-gray-200 rounded-full mx-auto overflow-hidden">
      <div class="h-full bg-[#0d2a66] rounded-full animate-pulse"></div>
    </div>
  </div>
</div>

<!-- Shared Layout Wrapper -->
<app-layout-wrapper pageTitle="Dashboard">
  <!-- Enhanced Page Content -->
  <div class="p-8 space-y-10 max-w-7xl mx-auto">
    
    <!-- Enhanced Hero Welcome Section -->
    <div class="welcome-section professional-card">
      <div class="flex items-center justify-between">
        <div class="space-y-4">
          <div class="flex items-center space-x-3">
            <div class="icon-container h-12 w-12">
              <span class="material-icons text-white text-xl">dashboard</span>
            </div>
            <div>
              <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Welcome back, {{ currentUser.name }}!</h1>
              <p class="text-gray-600 text-lg">Here's your business overview for today</p>
            </div>
          </div>
          
          <!-- Enhanced Status Indicators -->
          <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-2">
              <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-sm text-gray-600 font-medium">System Online</span>
            </div>
            <div class="flex items-center space-x-2">
              <div class="h-3 w-3 bg-blue-500 rounded-full"></div>
              <span class="text-sm text-gray-600 font-medium">{{ getCurrentDate() }}</span>
            </div>
            <div class="flex items-center space-x-2">
              <span class="material-icons text-gray-400 text-sm">access_time</span>
              <span class="text-sm text-gray-600 font-medium">{{ getCurrentTime() }}</span>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Action Buttons -->
        <div class="hidden md:flex items-center space-x-3">
          <button (click)="refreshDashboard()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-semibold interactive-element">
            <span class="material-icons mr-2 text-lg">refresh</span>
            <span>Refresh</span>
          </button>
          <button class="enhanced-btn flex items-center space-x-2">
            <span class="material-icons text-lg">rocket_launch</span>
            <span>Quick Action</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Enhanced Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
      <!-- Loading State -->
      <div *ngIf="isLoadingStats" class="col-span-full">
        <div class="text-center py-12">
          <div class="animate-spin rounded-full h-10 w-10 border-3 border-gray-200 border-t-[#0d2a66] mx-auto"></div>
          <p class="mt-4 text-gray-600 font-medium">Loading analytics...</p>
        </div>
      </div>
      
      <!-- Error State -->
      <div *ngIf="statsError && !isLoadingStats" class="col-span-full">
        <div class="text-center py-12 professional-card">
          <span class="material-icons text-red-500 text-5xl">error_outline</span>
          <div class="text-red-600 font-semibold mt-3 text-lg">Failed to load statistics</div>
          <p class="text-gray-600 mt-1">Please check your connection and try again</p>
          <button (click)="retryStats()" class="enhanced-btn mt-4">
            <span class="material-icons mr-2 text-sm">refresh</span>
            Retry Loading
          </button>
        </div>
      </div>
      
      <!-- Enhanced Statistics Cards -->
      <div *ngFor="let stat of getStatCards(); trackBy: trackByStatTitle" class="stat-card">
        <div class="flex justify-between items-start mb-4">
          <div class="flex-1">
            <div class="flex items-center space-x-2 mb-2">
              <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide">{{ stat.title }}</h3>
              <div class="h-1 w-8 rounded-full opacity-30" [class]="getStatBgClass(stat.color)"></div>
            </div>
            
            <div class="space-y-3">
              <p class="text-3xl font-bold text-gray-900 tracking-tight">{{ stat.value }}</p>
              
              <!-- Enhanced Trend Indicator -->
              <div class="flex items-center space-x-2">
                <div [class]="'flex items-center px-2 py-1 rounded-full text-xs font-semibold ' + 
                             (stat.changeType === 'increase' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700')">
                  <span class="material-icons text-xs mr-1">
                    {{ stat.changeType === 'increase' ? 'trending_up' : 'trending_down' }}
                  </span>
                  {{ stat.change }}
                </div>
                <span class="text-xs text-gray-500">vs last month</span>
              </div>
              
              <!-- Enhanced Progress Bar -->
              <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                <div [class]="'h-full rounded-full transition-all duration-1000 ' + 
                             (stat.changeType === 'increase' ? 'bg-green-500' : 'bg-red-500')" 
                     [style.width.%]="getProgressWidth(stat.change)"></div>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Icon Container -->
          <div [class]="'h-14 w-14 rounded-xl flex items-center justify-center shadow-sm interactive-element ' + getStatBgClass(stat.color)">
            <span [class]="'material-icons text-2xl ' + getStatColorClass(stat.color)">{{ stat.icon }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Main Dashboard Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <!-- Enhanced Recent Activity -->
      <div class="lg:col-span-8 professional-card">
        <!-- Enhanced Header -->
        <div class="p-6 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="h-10 w-10 rounded-lg bg-[#0d2a66]/10 flex items-center justify-center">
                <span class="material-icons text-[#0d2a66]">timeline</span>
              </div>
              <div>
                <h2 class="text-xl font-bold text-gray-900">Recent Activity</h2>
                <p class="text-sm text-gray-600">Live updates from your system</p>
              </div>
            </div>
            <div class="flex items-center space-x-2">
              <div class="h-2 w-2 bg-green-500 rounded-full animate-pulse"></div>
              <span class="text-xs text-gray-500 font-medium">Live</span>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Content -->
        <div class="p-6 activity-scroll">
          <!-- Loading State -->
          <div *ngIf="isLoadingActivities" class="text-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-2 border-gray-200 border-t-[#0d2a66] mx-auto"></div>
            <p class="mt-3 text-gray-600">Loading activities...</p>
          </div>

          <!-- Error State -->
          <div *ngIf="activitiesError && !isLoadingActivities" class="text-center py-12">
            <span class="material-icons text-red-400 text-4xl">sync_problem</span>
            <div class="text-red-600 font-semibold mt-2">Failed to load activities</div>
            <button (click)="retryActivities()" class="enhanced-btn mt-3 text-sm">
              <span class="material-icons mr-1 text-xs">refresh</span>
              Retry
            </button>
          </div>

          <!-- No Activities State -->
          <div *ngIf="!isLoadingActivities && !activitiesError && recentActivities.length === 0" class="text-center py-12">
            <div class="h-16 w-16 mx-auto bg-gray-100 rounded-2xl flex items-center justify-center mb-4">
              <span class="material-icons text-gray-400 text-2xl">history_toggle_off</span>
            </div>
            <div class="text-gray-600 font-semibold">No recent activities</div>
            <p class="text-gray-500 text-sm mt-1">Activities will appear here as they happen</p>
          </div>

          <!-- Enhanced Activities Timeline -->
          <div *ngIf="!isLoadingActivities && !activitiesError && recentActivities.length > 0" class="space-y-6">
            <div *ngFor="let activity of recentActivities; trackBy: trackByActivityId; let last = last" 
                 class="timeline-item activity-card p-4"
                 [class.border-b]="!last"
                 [class.border-gray-100]="!last">
              
              <div class="flex items-start space-x-4">
                <!-- Enhanced Activity Icon -->
                <div class="flex-shrink-0">
                  <div [class]="'h-10 w-10 rounded-xl flex items-center justify-center shadow-sm interactive-element ' + activity.color">
                    <span class="material-icons text-white text-lg">{{ activity.icon }}</span>
                  </div>
                </div>
                
                <!-- Enhanced Activity Content -->
                <div class="flex-1 min-w-0">
                  <h3 class="text-base font-semibold text-gray-900">{{ activity.title }}</h3>
                  <p class="text-gray-600 mt-1">{{ activity.description }}</p>
                  <div class="flex items-center space-x-3 mt-3">
                    <span class="text-xs text-gray-500 font-medium bg-gray-100 px-2 py-1 rounded-full">{{ formatActivityTime(activity.timestamp) }}</span>
                    <span class="text-xs text-gray-400 capitalize">{{ activity.type }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Enhanced View All Button -->
            <div class="pt-4 border-t border-gray-100">
              <button class="w-full text-center py-3 text-[#0d2a66] font-semibold hover:bg-[#0d2a66]/5 rounded-lg transition-colors interactive-element">
                View All Activities
                <span class="material-icons ml-1 text-sm">arrow_forward</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Enhanced Right Sidebar -->
      <div class="lg:col-span-4 space-y-6">
        
        <!-- Enhanced Quick Actions Panel -->
        <div class="professional-card">
          <div class="p-6 border-b border-gray-100">
            <div class="flex items-center space-x-3">
              <div class="h-8 w-8 rounded-lg bg-[#0d2a66]/10 flex items-center justify-center">
                <span class="material-icons text-[#0d2a66] text-sm">flash_on</span>
              </div>
              <h2 class="text-lg font-bold text-gray-900">Quick Actions</h2>
            </div>
          </div>
          <div class="p-6">
            <div class="grid grid-cols-2 gap-3">
              <a routerLink="/users" class="quick-action-btn">
                <div class="flex flex-col items-center space-y-2">
                  <div class="h-10 w-10 rounded-lg bg-[#0d2a66]/10 flex items-center justify-center">
                    <span class="material-icons text-[#0d2a66]">group</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-700">Users</span>
                </div>
              </a>
              
              <a routerLink="/reports" class="quick-action-btn">
                <div class="flex flex-col items-center space-y-2">
                  <div class="h-10 w-10 rounded-lg bg-green-100 flex items-center justify-center">
                    <span class="material-icons text-green-600">assessment</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-700">Reports</span>
                </div>
              </a>
              
              <a routerLink="/settings" class="quick-action-btn">
                <div class="flex flex-col items-center space-y-2">
                  <div class="h-10 w-10 rounded-lg bg-purple-100 flex items-center justify-center">
                    <span class="material-icons text-purple-600">settings</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-700">Settings</span>
                </div>
              </a>
              
              <a routerLink="/profile" class="quick-action-btn">
                <div class="flex flex-col items-center space-y-2">
                  <div class="h-10 w-10 rounded-lg bg-blue-100 flex items-center justify-center">
                    <span class="material-icons text-blue-600">person</span>
                  </div>
                  <span class="text-sm font-semibold text-gray-700">Profile</span>
                </div>
              </a>
            </div>
          </div>
        </div>

        <!-- Enhanced System Status -->
        <div class="professional-card">
          <div class="p-6 border-b border-gray-100">
            <div class="flex items-center space-x-3">
              <div class="h-8 w-8 rounded-lg bg-green-100 flex items-center justify-center">
                <span class="material-icons text-green-600 text-sm">shield</span>
              </div>
              <h2 class="text-lg font-bold text-gray-900">System Status</h2>
            </div>
          </div>
          <div class="p-6">
            <div class="space-y-4">
              <!-- Enhanced Status Indicators -->
              <div class="status-indicator online">
                <div class="flex items-center space-x-3">
                  <div class="h-3 w-3 bg-green-500 rounded-full animate-pulse"></div>
                  <span class="text-sm font-semibold text-green-800">Server</span>
                </div>
                <span class="text-xs text-green-600 font-medium">Online</span>
              </div>
              
              <div class="status-indicator online">
                <div class="flex items-center space-x-3">
                  <div class="h-3 w-3 bg-green-500 rounded-full"></div>
                  <span class="text-sm font-semibold text-green-800">Database</span>
                </div>
                <span class="text-xs text-green-600 font-medium">Connected</span>
              </div>
              
              <div class="status-indicator warning">
                <div class="flex items-center space-x-3">
                  <div class="h-3 w-3 bg-yellow-500 rounded-full"></div>
                  <span class="text-sm font-semibold text-yellow-800">API</span>
                </div>
                <span class="text-xs text-yellow-600 font-medium">Maintenance</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Encryption Test Section -->
    <div class="encryption-section">
      <div class="encryption-header">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div class="icon-container h-12 w-12">
              <span class="material-icons text-white text-xl">security</span>
            </div>
            <div>
              <h2 class="text-xl font-bold text-gray-900">Hybrid Encryption Test</h2>
              <p class="text-gray-600">Test secure encryption and decryption functionality</p>
            </div>
          </div>
          <div class="hidden md:flex items-center space-x-2 px-3 py-1 bg-white rounded-full shadow-sm">
            <div class="h-2 w-2 bg-blue-500 rounded-full animate-pulse"></div>
            <span class="text-xs text-gray-600 font-medium">Ready</span>
          </div>
        </div>
      </div>
      
      <div class="encryption-content">
        <div class="max-w-2xl space-y-6">
          <!-- Enhanced Input Section -->
          <div class="space-y-3">
            <label for="testMessage" class="block text-sm font-semibold text-gray-800">
              Message to Encrypt
            </label>
            <div class="relative">
              <textarea
                id="testMessage"
                [(ngModel)]="testMessage"
                rows="4"
                class="enhanced-input w-full resize-none"
                placeholder="Enter a message to test hybrid encryption..."
              ></textarea>
              <div class="absolute bottom-3 right-3 text-xs text-gray-400">
                {{ testMessage.length }} characters
              </div>
            </div>
          </div>

          <!-- Enhanced Action Buttons -->
          <div class="flex flex-wrap gap-3">
            <button
              (click)="testEncryption()"
              [disabled]="isEncrypting || !testMessage.trim()"
              class="enhanced-btn flex items-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
              <span *ngIf="!isEncrypting" class="material-icons text-lg">lock</span>
              <div *ngIf="isEncrypting" class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
              <span>{{ isEncrypting ? 'Encrypting...' : 'Test Encryption' }}</span>
            </button>
            
            <button
              (click)="clearTest()"
              class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-semibold interactive-element">
              <span class="material-icons mr-2 text-lg">clear</span>
              <span>Clear</span>
            </button>
          </div>

          <!-- Enhanced Results -->
          <div *ngIf="encryptionResult" class="result-card">
            <div class="flex items-start space-x-3">
              <div class="h-8 w-8 rounded-lg bg-green-500 flex items-center justify-center flex-shrink-0">
                <span class="material-icons text-white text-sm">check_circle</span>
              </div>
              <div class="flex-1 space-y-3">
                <h3 class="text-lg font-bold text-green-800">Encryption Test Successful!</h3>
                <div class="space-y-2 text-sm">
                  <div class="p-3 bg-white rounded-lg border border-green-200">
                    <p class="font-semibold text-gray-700 mb-1">Original Message:</p>
                    <p class="text-gray-600 font-mono bg-gray-50 p-2 rounded text-xs">{{ testMessage }}</p>
                  </div>
                  <div class="p-3 bg-white rounded-lg border border-green-200">
                    <p class="font-semibold text-gray-700 mb-1">Decrypted Response:</p>
                    <p class="text-gray-600 font-mono bg-gray-50 p-2 rounded text-xs">{{ encryptionResult }}</p>
                  </div>
                  <div class="p-3 bg-green-100 rounded-lg">
                    <p class="text-green-700 font-semibold">âœ“ Data was encrypted, sent to server, and decrypted correctly</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Error Display -->
          <div *ngIf="encryptionError" class="result-card error">
            <div class="flex items-start space-x-3">
              <div class="h-8 w-8 rounded-lg bg-red-500 flex items-center justify-center flex-shrink-0">
                <span class="material-icons text-white text-sm">error</span>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-bold text-red-800 mb-2">Encryption Test Failed</h3>
                <p class="text-red-700 bg-white p-3 rounded-lg border border-red-200 font-mono text-sm">{{ encryptionError }}</p>
              </div>
            </div>
          </div>

          <!-- Enhanced Quick Link -->
          <div class="pt-6 border-t border-gray-200">
            <a routerLink="/hybrid-encryption-test" 
               class="group flex items-center space-x-3 text-[#0d2a66] hover:text-[#0d2a66]/80 transition-colors interactive-element">
              <span class="material-icons">open_in_new</span>
              <span class="font-semibold">Open Full Encryption Test Page</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</app-layout-wrapper>


                   